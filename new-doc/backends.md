<!-- SPDX-License-Identifier: CC-BY-SA-4.0 -->
<!-- SPDX-FileCopyrightText: 2020 The LumoSQL Authors -->
<!-- SPDX-ArtifactOfProjectName: LumoSQL -->
<!-- SPDX-FileType: Documentation -->
<!-- SPDX-FileComment: Original by Dan Shearer, 2019 -->




Table of Contents
=================

   * [LumoSQL Backend Storage Engines](#lumosql-backend-storage-engines)
   * [SQLite and BDB Compatibility](#sqlite-and-bdb-compatibility)
   * [Notes on the Port of SQLite to BDB](#notes-on-the-port-of-sqlite-to-bdb)
   * [Versions and availability](#versions-and-availability)
   * [Running Out of the Box](#running-out-of-the-box)
   * [Design of the Port](#design-of-the-port)
      * [Files and Directories](#files-and-directories)
      * [Code Changes](#code-changes)

# LumoSQL Backend Storage Engines
LumoSQL supports the SQLite [b-tree](https://sqlite.org/src4/doc/trunk/www/bt.wiki) format as well as [LMDB](http://www.lmdb.tech/doc/) and [BDB](https://docs.oracle.com/database/bdb181/html/gsg/C/BerkeleyDB-Core-C-GSG.pdf#%5B%7B%22num%22%3A44%2C%22gen%22%3A0%7D%2C%7B%22name%22%3A%22XYZ%22%7D%2C86.4%2C691.2%2Cnull%5D) discussed below.

[adding new backends](./3.5-lumo-test-build.md#adding-new-backends)

# SQLite and BDB Compatibility

# Notes on the Port of SQLite to BDB

The work described in this document is part of an ongoing project to test,
document and consolidate source code for numerous back-end storage systems that
have been ported to SQLite in various ways. There are 4 key-value stores used
at scale and widely-ported that have the property of being
[MVCC](https://en.wikipedia.org/wiki/Multiversion_concurrency_control). BDB is
one of them.

# Versions and availability


BDB is freely available under the GNU AGPL license. It was formerly Sleepycat
BDB, before Sleepycat was purchased by Oracle.

BDB version 18.1.32 was the last to have a port of SQLite to BDB included. From
the 
[release notes for BDB 18.1.40](https://download.oracle.com/otndocs/products/berkeleydb/html/changelog_18_1_40.html):

> **Changes between version 18.1.32 and version 18.1.40** [..]
> The SQL API is no longer supported. 
> If you require SQL support you must use Berkeley DB 18.1.32 or earlier. 

BDB 18.1.32 contains scripts that patch SQLite 3.18.2 to have BDB support. The scripts are 
intended to assist with forward-porting to later versions of SQLite.

A convenient place to get the source for BDB 18.1.32 is
[Bintray](https://bintray.com/version/files/homebrew/mirror/berkeley-db/18.1.32)
.  It is also available at an Oracle site that requires a login. 

This document will refer to the port as BDB-SQLite, because SQLite was modified
to fit BDB, not the other way around. This is the how nearly all of the many
projects that provide a different storage backend for SQLite have approached
the task.

# Running Out of the Box

Comments and documentation for BDB-SQLite suggest it should compile and run on
many platforms including some quite niche embedded operating systems.  However
we have only tested BDB-SQLite on common and current Linux distributions, where
the process is:

```
tar zxvf berkeley-db-18.1.32.tar.gz
cd db-18.1.32/build
./configure --enable-sql_compat
```

This will create:
  1) libdb_sqlXX.{so|la} - A C API library, that exactly mirrors the SQLite
     C API.
  2) dbsql - A command line SQL interpreter, that exactly matches
     the default sqlite3 command line interpreter.
  3) sqlite.{so|la} - A C API library, that exactly mirrors the SQLite C API,
     and has the same name as the library generated by a SQLite build.
  4) sqlite3 - A command line SQL interpreter, that exactly matches the 
     semantics and name of the default sqlite3 command line interpreter.

# Design of the Port

## Files and Directories

db-18.1.32/lang/sql/sqlite has the unmodified source for SQLite 3.18.2

db-18.1.32/lang/sql/adaptor has all of the replaced SQLite source files, 
such as btree.c

db-18.1.32/lang/sql/adaptor/sqlite-patches has 43 patches that modify the SQLite
sources. Most of them are very small patches, often just a line or two:

* inserting DB-specific files into the Makefile (eg the DB-specific pragmas)
* branding (eg 07_shell_prompt.patch)
* build fixes for less common platforms (Solaris, VS, Cygwin etc)
* 11 modifications to the test code that comes with SQLite

db-18.1.32/dist/s_sql_upgrade is a script to help with upgrading the SQLite version

## Code Changes

In lang/sql/adaptor the significant files replaced are:

btree.c
backup.c
btreeInt.h
vacuum.c
userauth.c
userauth.h

There are also placeholder files, containing only function definitons and a
tiny amount of code. But most of these are not needed and a cleaner port would
probably eliminate them altogether:

backup.h
backup.c
pager.c
pager.h
btmutex.c
pcache.h  (stubs only, no code)
pcache.c  (stubs only, no code)
wal.h     (stubs only, no code)
pcache1.c (stubs only, no code)
wal.c     (stubs only, no code)

In addition there are files added to SQLite for entirely BDB-specific functionality. These
could probably be easily removed from the build without causing problems elsewhere:

db_encrypt.c
db_pragma.c
db_sequence.c
db_shell.c 
